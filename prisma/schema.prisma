generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ListingType {
  shop
  artist
  supplier
}

enum PriceRange {
  budget
  moderate
  premium
  luxury
}

enum ListingStatus {
  active
  pending
  inactive
}

enum UserRole {
  owner
  admin
}

enum ClaimStatus {
  pending
  approved
  denied
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  name         String
  role         UserRole @default(owner)
  claims       Claim[]
  listings     Listing[] @relation("OwnedListings")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Claim {
  id         Int         @id @default(autoincrement())
  userId     Int
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  listingId  Int
  listing    Listing     @relation(fields: [listingId], references: [id], onDelete: Cascade)
  status     ClaimStatus @default(pending)
  message    String?
  adminNotes String?
  reviewedAt DateTime?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@unique([userId, listingId])
  @@index([status])
  @@index([userId])
  @@index([listingId])
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String
  slug        String    @unique
  description String?
  type        ListingType
  icon        String?
  parentId    Int?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  sortOrder   Int       @default(0)
  listings    ListingCategory[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([type])
}

model State {
  id           Int      @id @default(autoincrement())
  name         String
  abbreviation String   @unique
  slug         String   @unique
  cities       City[]
  listings     Listing[]
}

model City {
  id         Int      @id @default(autoincrement())
  name       String
  slug       String
  stateId    Int
  state      State    @relation(fields: [stateId], references: [id])
  population Int?
  latitude   Float?
  longitude  Float?
  metroArea  String?
  imageUrl   String?
  listings   Listing[]

  @@unique([slug, stateId])
  @@index([stateId])
}

model Listing {
  id                Int             @id @default(autoincrement())
  name              String
  slug              String          @unique
  description       String?
  type              ListingType
  phone             String?
  website           String?
  email             String?
  address           String?
  cityId            Int
  city              City            @relation(fields: [cityId], references: [id])
  stateId           Int
  state             State           @relation(fields: [stateId], references: [id])
  zipCode           String?
  latitude          Float?
  longitude         Float?
  priceRange        PriceRange?
  styles            Json?
  acceptsWalkIns    Boolean         @default(false)
  minimumAge        Int?
  piercingServices  Boolean         @default(false)
  portfolioUrl      String?
  amenities         Json?
  hours             Json?
  photos            Json?
  googlePlaceId     String?
  googleRating      Float?
  googleReviewCount Int?
  status            ListingStatus   @default(active)
  featured          Boolean         @default(false)
  ownerId           Int?
  owner             User?           @relation("OwnedListings", fields: [ownerId], references: [id], onDelete: SetNull)
  categories        ListingCategory[]
  claims            Claim[]
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([cityId, status])
  @@index([stateId, status])
  @@index([type, status])
}

model ListingCategory {
  listingId  Int
  listing    Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([listingId, categoryId])
  @@index([categoryId])
}
